# CTP Wrapper Makefile
# æ”¯æŒ macOS å’Œ Linux å¹³å°

# Linuxç‰¹å®šé…ç½®
OS = linux
LIB_DIR = ../lib
SHARED_EXT = so
LINKER_FLAGS = -L$(LIB_DIR) -lthostmduserapi_se -lthosttraderapi_se -lpthread -ldl

# ç¼–è¯‘å™¨å’Œæ ‡å¿—
CXX = g++
CXXFLAGS = -fPIC -std=c++11 -O2 -Wall
INCLUDES = -I../include -I../../common

# æºæ–‡ä»¶
SOURCES = spi_bridge.cpp ctp_wrapper.cpp ../../common/debug_logger.cpp
OBJECTS = $(SOURCES:.cpp=.o)

# ç›®æ ‡æ–‡ä»¶
SHARED_LIB = libctp_wrapper.$(SHARED_EXT)
STATIC_LIB = libctp_wrapper.a

.PHONY: all clean shared static test help

# é»˜è®¤ç›®æ ‡
all: shared

# ç¼–è¯‘å…±äº«åº“
shared: $(SHARED_LIB)

$(SHARED_LIB): $(OBJECTS)
	@echo "ğŸ”— é“¾æ¥å…±äº«åº“: $@"
	$(CXX) -shared $(OBJECTS) $(LINKER_FLAGS) -o $@
	@echo "âœ… å…±äº«åº“ç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘é™æ€åº“
static: $(STATIC_LIB)

$(STATIC_LIB): $(OBJECTS)
	@echo "ğŸ“¦ åˆ›å»ºé™æ€åº“: $@"
	ar rcs $@ $(OBJECTS)
	@echo "âœ… é™æ€åº“ç¼–è¯‘å®Œæˆ"

# ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
%.o: %.cpp
	@echo "ğŸ”¨ ç¼–è¯‘: $<"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘äº§ç‰©..."
	rm -f *.o *.$(SHARED_EXT) *.a
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æµ‹è¯•ç¼–è¯‘
test: $(SHARED_LIB)
	@echo "ğŸ§ª æµ‹è¯•åº“æ–‡ä»¶..."
	file $(SHARED_LIB)
ifeq ($(OS),macos)
	otool -L $(SHARED_LIB)
else
	ldd $(SHARED_LIB)
endif

# å®‰è£… (å¤åˆ¶åˆ°ç³»ç»Ÿåº“ç›®å½•)
install: $(SHARED_LIB)
	@echo "ğŸ“¦ å®‰è£…åº“æ–‡ä»¶..."
ifeq ($(OS),macos)
	sudo cp $(SHARED_LIB) /usr/local/lib/
	sudo install_name_tool -id /usr/local/lib/$(SHARED_LIB) /usr/local/lib/$(SHARED_LIB)
else
	sudo cp $(SHARED_LIB) /usr/local/lib/
	sudo ldconfig
endif
	@echo "âœ… å®‰è£…å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "CTP Wrapper ç¼–è¯‘å¸®åŠ©"
	@echo "===================="
	@echo "make            - ç¼–è¯‘å…±äº«åº“ (é»˜è®¤)"
	@echo "make shared     - ç¼–è¯‘å…±äº«åº“"
	@echo "make static     - ç¼–è¯‘é™æ€åº“"
	@echo "make all        - ç¼–è¯‘å…±äº«åº“"
	@echo "make clean      - æ¸…ç†ç¼–è¯‘äº§ç‰©"
	@echo "make test       - æµ‹è¯•ç¼–è¯‘ç»“æœ"
	@echo "make install    - å®‰è£…åˆ°ç³»ç»Ÿç›®å½•"
	@echo "make help       - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "å½“å‰å¹³å°: $(OS)"
	@echo "åº“ç›®å½•: $(LIB_DIR)"
	@echo "å…±äº«åº“æ‰©å±•å: $(SHARED_EXT)"
