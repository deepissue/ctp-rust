# CTP Wrapper ç»Ÿä¸€ Makefile
# è‡ªåŠ¨æ£€æµ‹å¹³å°å¹¶ä½¿ç”¨ç›¸åº”çš„é…ç½®

# è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿ
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    DETECTED_OS = linux
endif
ifeq ($(UNAME_S),Darwin)
    DETECTED_OS = macos
endif

# å…è®¸ç”¨æˆ·è¦†ç›–æ£€æµ‹çš„ç³»ç»Ÿç±»å‹
OS ?= $(DETECTED_OS)

# å¹³å°ç‰¹å®šé…ç½®
ifeq ($(OS),linux)
    # Linux é…ç½®
    PLATFORM_DEFINE = -DCTP_PLATFORM_LINUX
    LIB_DIR = ../linux/lib
    SHARED_EXT = so
    CXX = g++
    PLATFORM_CXXFLAGS =
    LINKER_FLAGS = -L$(LIB_DIR) -lthostmduserapi_se -lthosttraderapi_se -lpthread -ldl
    INCLUDES = -I../linux/include
else ifeq ($(OS),macos)
    # macOS é…ç½®
    PLATFORM_DEFINE = -DCTP_PLATFORM_MACOS
    LIB_DIR = ../mac64/lib
    SHARED_EXT = dylib
    CXX = clang++
    PLATFORM_CXXFLAGS = -mmacosx-version-min=14.0
    LINKER_FLAGS = -L$(LIB_DIR) -lthostmduserapi_se -lthosttraderapi_se
    INCLUDES = -I../mac64/include
else
    $(error ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $(OS). æ”¯æŒçš„ç³»ç»Ÿ: linux, macos)
endif

# é€šç”¨ç¼–è¯‘å™¨æ ‡å¿—
CXXFLAGS = -fPIC -std=c++11 -O2 -Wall $(PLATFORM_DEFINE) $(PLATFORM_CXXFLAGS)

# æºæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶
SOURCES = spi_bridge.cpp ctp_wrapper.cpp logger.cpp
OBJECTS = $(SOURCES:.cpp=.o)
SHARED_LIB = libctp_wrapper.$(SHARED_EXT)
STATIC_LIB = libctp_wrapper.a

# ä¼ªç›®æ ‡
.PHONY: all clean shared static test help info

# é»˜è®¤ç›®æ ‡
all: info shared

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
info:
	@echo "ğŸ”§ CTP Wrapper æ„å»ºä¿¡æ¯"
	@echo "======================="
	@echo "æ£€æµ‹åˆ°çš„ç³»ç»Ÿ: $(DETECTED_OS)"
	@echo "ç›®æ ‡ç³»ç»Ÿ: $(OS)"
	@echo "ç¼–è¯‘å™¨: $(CXX)"
	@echo "åº“ç›®å½•: $(LIB_DIR)"
	@echo "å…±äº«åº“æ‰©å±•å: $(SHARED_EXT)"
	@echo "å¹³å°å®šä¹‰: $(PLATFORM_DEFINE)"
	@echo ""

# ç¼–è¯‘å…±äº«åº“
shared: clean $(SHARED_LIB)
	rm -f *.o

$(SHARED_LIB): $(OBJECTS)
	@echo "ğŸ”— é“¾æ¥å…±äº«åº“ [$(OS)]: $@"
	$(CXX) -shared $(OBJECTS) $(LINKER_FLAGS) -o $@
	@echo "âœ… å…±äº«åº“ç¼–è¯‘å®Œæˆ: $@"

# ç¼–è¯‘é™æ€åº“
static: $(STATIC_LIB)

$(STATIC_LIB): $(OBJECTS)
	@echo "ğŸ“¦ åˆ›å»ºé™æ€åº“ [$(OS)]: $@"
	ar rcs $@ $(OBJECTS)
	@echo "âœ… é™æ€åº“ç¼–è¯‘å®Œæˆ: $@"

# ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
%.o: %.cpp
	@echo "ğŸ”¨ ç¼–è¯‘ [$(OS)]: $<"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘äº§ç‰© [$(OS)]..."
	rm -f *.o *.$(SHARED_EXT) *.a
	rm -f ../common/*.o
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æµ‹è¯•ç¼–è¯‘ç»“æœ
test: $(SHARED_LIB)
	@echo "ğŸ§ª æµ‹è¯•åº“æ–‡ä»¶ [$(OS)]: $(SHARED_LIB)"
	file $(SHARED_LIB)
ifeq ($(OS),macos)
	@echo "ğŸ“‹ ä¾èµ–åº“ä¿¡æ¯:"
	otool -L $(SHARED_LIB)
else
	@echo "ğŸ“‹ ä¾èµ–åº“ä¿¡æ¯:"
	ldd $(SHARED_LIB) || true
endif
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# å®‰è£…åˆ°ç³»ç»Ÿç›®å½•
install: $(SHARED_LIB)
	@echo "ğŸ“¦ å®‰è£…åº“æ–‡ä»¶ [$(OS)]..."
ifeq ($(OS),macos)
	sudo cp $(SHARED_LIB) /usr/local/lib/
	sudo install_name_tool -id /usr/local/lib/$(SHARED_LIB) /usr/local/lib/$(SHARED_LIB)
else
	sudo cp $(SHARED_LIB) /usr/local/lib/
	sudo ldconfig
endif
	@echo "âœ… å®‰è£…å®Œæˆ"

# äº¤å‰ç¼–è¯‘æ”¯æŒ
linux:
	$(MAKE) OS=linux

macos:
	$(MAKE) OS=macos

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "CTP Wrapper ç»Ÿä¸€æ„å»ºç³»ç»Ÿ"
	@echo "========================"
	@echo ""
	@echo "åŸºæœ¬ç”¨æ³•:"
	@echo "  make              - æ˜¾ç¤ºä¿¡æ¯å¹¶ç¼–è¯‘å…±äº«åº“ (è‡ªåŠ¨æ£€æµ‹å¹³å°)"
	@echo "  make shared       - ç¼–è¯‘å…±äº«åº“"
	@echo "  make static       - ç¼–è¯‘é™æ€åº“"
	@echo "  make test         - æµ‹è¯•ç¼–è¯‘ç»“æœ"
	@echo "  make clean        - æ¸…ç†ç¼–è¯‘äº§ç‰©"
	@echo "  make install      - å®‰è£…åˆ°ç³»ç»Ÿç›®å½•"
	@echo ""
	@echo "å¹³å°ç‰¹å®šæ„å»º:"
	@echo "  make linux        - å¼ºåˆ¶ä½¿ç”¨ Linux é…ç½®ç¼–è¯‘"
	@echo "  make macos        - å¼ºåˆ¶ä½¿ç”¨ macOS é…ç½®ç¼–è¯‘"
	@echo "  make OS=linux     - æŒ‡å®šç›®æ ‡ç³»ç»Ÿä¸º Linux"
	@echo "  make OS=macos     - æŒ‡å®šç›®æ ‡ç³»ç»Ÿä¸º macOS"
	@echo ""
	@echo "å®ç”¨å·¥å…·:"
	@echo "  make info         - æ˜¾ç¤ºæ„å»ºé…ç½®ä¿¡æ¯"
	@echo "  make help         - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "å½“å‰æ£€æµ‹ç³»ç»Ÿ: $(DETECTED_OS)"
	@echo "æ”¯æŒçš„ç³»ç»Ÿ: linux, macos"
